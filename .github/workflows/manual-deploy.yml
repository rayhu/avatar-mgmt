# .github/workflows/manual-deploy.yml
name: Manual Deployment
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (e.g., v1.0.0, latest, staging)'
        required: true
        default: 'latest'
        type: string
      force_deploy:
        description: 'Force deployment even if version validation fails'
        required: false
        default: false
        type: boolean

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validation.outputs.is_valid }}
      image_tag: ${{ steps.validation.outputs.image_tag }}
      environment: ${{ steps.validation.outputs.environment }}
      version_display: ${{ steps.validation.outputs.version_display }}
      version_type: ${{ steps.validation.outputs.version_type }}
    steps:
      - name: Validate deployment inputs
        id: validation
        run: |
          echo "ğŸ” Validating deployment inputs..."
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Force Deploy: ${{ github.event.inputs.force_deploy }}"

          # éªŒè¯ç¯å¢ƒ
          if [[ "${{ github.event.inputs.environment }}" != "staging" && "${{ github.event.inputs.environment }}" != "production" ]]; then
            echo "âŒ Invalid environment: ${{ github.event.inputs.environment }}"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # è®¾ç½®é•œåƒæ ‡ç­¾å’Œç‰ˆæœ¬æ˜¾ç¤º
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" == "latest" ]]; then
            IMAGE_TAG="$VERSION"
            VERSION_DISPLAY="latest (main branch)"
            VERSION_TYPE="latest"
          elif [[ "$VERSION" == "staging" ]]; then
            IMAGE_TAG="$VERSION"
            VERSION_DISPLAY="staging (main branch)"
            VERSION_TYPE="staging"
          elif [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            IMAGE_TAG="$VERSION"
            VERSION_DISPLAY="$VERSION"
            VERSION_TYPE="release"
          else
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected formats: latest, staging, v1.0.0, v1.0.0-beta.1"
            if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
              echo "âš ï¸ Force deploy enabled, proceeding with version: $VERSION"
              IMAGE_TAG="$VERSION"
              VERSION_DISPLAY="$VERSION (forced)"
              VERSION_TYPE="custom"
            else
              echo "is_valid=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "is_valid=true" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "version_display=$VERSION_DISPLAY" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

          echo "âœ… Validation passed"
          echo "  Environment: ${{ github.event.inputs.environment }}"
          echo "  Image Tag: $IMAGE_TAG"
          echo "  Version Display: $VERSION_DISPLAY"
          echo "  Version Type: $VERSION_TYPE"

      - name: Display version information
        run: |
          echo "ğŸ·ï¸ Version Information:"
          echo "  Input Version: ${{ github.event.inputs.version }}"
          echo "  Display Version: ${{ steps.validation.outputs.version_display }}"
          echo "  Version Type: ${{ steps.validation.outputs.version_type }}"
          echo "  Image Tag: ${{ steps.validation.outputs.image_tag }}"
          echo "  Environment: ${{ steps.validation.outputs.environment }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Triggered by: ${{ github.actor }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"

          echo ""
          echo "ğŸŒ Environment Information:"
          echo "  Target Environment: ${{ steps.validation.outputs.environment }}"
          if [[ "${{ steps.validation.outputs.environment }}" == "production" ]]; then
            echo "  ğŸš¨ PRODUCTION DEPLOYMENT - HIGH RISK"
            echo "  âš ï¸  This will deploy to production environment!"
          else
            echo "  ğŸ§ª STAGING DEPLOYMENT - TEST ENVIRONMENT"
            echo "  âœ… Safe for testing and validation"
          fi

      - name: Log in to Container Registry
        if: github.event.inputs.force_deploy == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check image availability
        if: github.event.inputs.force_deploy == 'false'
        run: |
          echo "ğŸ” Checking if images exist in GHCR..."

          # æ£€æŸ¥ API é•œåƒ
          API_IMAGE="ghcr.io/${{ github.repository }}/api:${{ steps.validation.outputs.image_tag }}"
          FRONTEND_IMAGE="ghcr.io/${{ github.repository }}/frontend:${{ steps.validation.outputs.image_tag }}"

          echo "Checking API image: $API_IMAGE"
          if docker manifest inspect "$API_IMAGE" > /dev/null 2>&1; then
            echo "âœ… API image found"
          else
            echo "âŒ API image not found: $API_IMAGE"
            exit 1
          fi

          echo "Checking Frontend image: $FRONTEND_IMAGE"
          if docker manifest inspect "$FRONTEND_IMAGE" > /dev/null 2>&1; then
            echo "âœ… Frontend image found"
          else
            echo "âŒ Frontend image not found: $FRONTEND_IMAGE"
            exit 1
          fi

          echo "âœ… All images are available"

  deploy:
    needs: validate-inputs
    if: needs.validate-inputs.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.validate-inputs.outputs.environment }}
    steps:
      - name: Deploy to ${{ needs.validate-inputs.outputs.environment }}
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ needs.validate-inputs.outputs.environment == 'production' && vars.PRODUCTION_HOST || vars.STAGING_HOST }}
          username: ${{ needs.validate-inputs.outputs.environment == 'production' && vars.PRODUCTION_USERNAME || vars.STAGING_USERNAME }}
          key: ${{ needs.validate-inputs.outputs.environment == 'production' && secrets.PRODUCTION_SSH_KEY || secrets.STAGING_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting manual deployment..."
            echo "=========================================="
            echo "ğŸ·ï¸ VERSION: ${{ needs.validate-inputs.outputs.version_display }}"
            echo "ğŸ·ï¸ VERSION TYPE: ${{ needs.validate-inputs.outputs.version_type }}"
            echo "=========================================="

            # ç¯å¢ƒæ ‡è¯†æ˜¾ç¤º
            if [[ "${{ needs.validate-inputs.outputs.environment }}" == "production" ]]; then
              echo "ğŸš¨ğŸš¨ğŸš¨ PRODUCTION DEPLOYMENT ğŸš¨ğŸš¨ğŸš¨"
              echo "ğŸš¨ğŸš¨ğŸš¨ PRODUCTION DEPLOYMENT ğŸš¨ğŸš¨ğŸš¨"
              echo "ğŸš¨ğŸš¨ğŸš¨ PRODUCTION DEPLOYMENT ğŸš¨ğŸš¨ğŸš¨"
              echo "=========================================="
              echo "âš ï¸  HIGH RISK: This will affect live users!"
              echo "âš ï¸  HIGH RISK: This will affect live users!"
              echo "=========================================="
            else
              echo "ğŸ§ªğŸ§ªğŸ§ª STAGING DEPLOYMENT ğŸ§ªğŸ§ªğŸ§ª"
              echo "ğŸ§ªğŸ§ªğŸ§ª STAGING DEPLOYMENT ğŸ§ªğŸ§ªğŸ§ª"
              echo "ğŸ§ªğŸ§ªğŸ§ª STAGING DEPLOYMENT ğŸ§ªğŸ§ªğŸ§ª"
              echo "=========================================="
              echo "âœ…  SAFE: This is a test environment"
              echo "âœ…  SAFE: This is a test environment"
              echo "=========================================="
            fi

            echo "Target Environment: ${{ needs.validate-inputs.outputs.environment }}"
            echo "Target Host: ${{ needs.validate-inputs.outputs.environment == 'production' && vars.PRODUCTION_HOST || vars.STAGING_HOST }}"
            echo "Image Tag: ${{ needs.validate-inputs.outputs.image_tag }}"
            echo "Repository: ${{ github.repository }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Deploy time: $(date)"
            echo "=========================================="

            # è®¾ç½®éƒ¨ç½²ç›®å½•
            if [ "${{ needs.validate-inputs.outputs.environment }}" = "production" ]; then
              DEPLOY_DIR="/opt/deploy-avatar"
              SOURCE_DIR="/opt/avatar-mgmt"
            else
              DEPLOY_DIR="/opt/deploy-avatar"
              SOURCE_DIR="/opt/avatar-mgmt"
            fi

            echo "Deploy directory: $DEPLOY_DIR"
            echo "Source directory: $SOURCE_DIR"

            # ç¡®ä¿ç›®å½•å­˜åœ¨
            sudo mkdir -p "$DEPLOY_DIR"
            sudo mkdir -p "$SOURCE_DIR"
            sudo chown -R $USER:$USER "$DEPLOY_DIR" "$SOURCE_DIR"

            # æ›´æ–°æºä»£ç 
            cd "$SOURCE_DIR"
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts
              git clone git@github.com:${{ github.repository }}.git .
            else
              echo "ğŸ“¥ Updating repository..."
              git fetch --all --tags
            fi

            # å¦‚æœæŒ‡å®šäº†å…·ä½“ç‰ˆæœ¬æ ‡ç­¾ï¼Œåˆ‡æ¢åˆ°è¯¥æ ‡ç­¾
            if [[ "${{ needs.validate-inputs.outputs.image_tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              echo "ğŸ”„ Checking out tag: ${{ needs.validate-inputs.outputs.image_tag }}"
              git checkout tags/${{ needs.validate-inputs.outputs.image_tag }}
            else
              echo "ğŸ”„ Using main branch for alias: ${{ needs.validate-inputs.outputs.image_tag }}"
              git checkout main
              git pull origin main
            fi

            # å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ
            cd "$DEPLOY_DIR"

            # å¤åˆ¶éƒ¨ç½²è„šæœ¬
            echo "ğŸ“‚ Copying deployment scripts..."
            cp "$SOURCE_DIR/.github/scripts/deploy-ghcr-simple.sh" .
            cp "$SOURCE_DIR/.github/scripts/health-check.sh" .
            chmod +x deploy-ghcr-simple.sh health-check.sh

            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            if [ ! -f ".env.api" ]; then
              echo "âŒ Config file not found: .env.api"
              exit 1
            fi
            if [ ! -f ".env.directus" ]; then
              echo "âŒ Config file not found: .env.directus"
              exit 1
            fi
            if [ ! -f ".env.frontend" ]; then
              echo "âŒ Config file not found: .env.frontend"
              exit 1
            fi


            # è®¾ç½®ç¯å¢ƒå˜é‡
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            export GITHUB_ACTOR="${{ github.actor }}"
            export GITHUB_REF_NAME="${{ needs.validate-inputs.outputs.image_tag }}"
            export GITHUB_SHA="${{ github.sha }}"
            export IMAGE_TAG="${{ needs.validate-inputs.outputs.image_tag }}"

            if [ "${{ needs.validate-inputs.outputs.environment }}" = "production" ]; then
              export PRODUCTION_HOST="${{ vars.PRODUCTION_HOST }}"
            else
              export STAGING_HOST="${{ vars.STAGING_HOST }}"
            fi

            # æ‰§è¡Œéƒ¨ç½²
            echo "ğŸš€ Starting deployment with image tag: ${{ needs.validate-inputs.outputs.image_tag }}"
            ./deploy-ghcr-simple.sh

            # å¥åº·æ£€æŸ¥
            echo "ğŸ” Starting health check..."
            export DOCKER_COMPOSE_FILE="docker-compose.ghcr.yml"
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export IMAGE_TAG="${{ needs.validate-inputs.outputs.image_tag }}"
            ./health-check.sh

            echo "âœ… Manual deployment completed successfully!"
            echo "ğŸ‰ Deployed ${{ needs.validate-inputs.outputs.image_tag }} to ${{ needs.validate-inputs.outputs.environment }}!"

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Manual deployment successful!"
          echo "=========================================="
          echo "ğŸ·ï¸ VERSION: ${{ needs.validate-inputs.outputs.version_display }}"
          echo "ğŸ·ï¸ VERSION TYPE: ${{ needs.validate-inputs.outputs.version_type }}"
          echo "=========================================="

          # ç¯å¢ƒæ ‡è¯†æ˜¾ç¤º
          if [[ "${{ needs.validate-inputs.outputs.environment }}" == "production" ]]; then
            echo "ğŸš¨ğŸš¨ğŸš¨ PRODUCTION DEPLOYMENT SUCCESS ğŸš¨ğŸš¨ğŸš¨"
            echo "âš ï¸  LIVE USERS ARE NOW USING THE NEW VERSION!"
          else
            echo "ğŸ§ªğŸ§ªğŸ§ª STAGING DEPLOYMENT SUCCESS ğŸ§ªğŸ§ªğŸ§ª"
            echo "âœ…  TEST ENVIRONMENT IS READY FOR TESTING!"
          fi
          echo "=========================================="

          echo "Environment: ${{ needs.validate-inputs.outputs.environment }}"
          echo "Version: ${{ needs.validate-inputs.outputs.image_tag }}"
          echo "Repository: ${{ github.repository }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Deploy time: $(date)"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Manual deployment failed!"
          echo "=========================================="
          echo "ğŸ·ï¸ VERSION: ${{ needs.validate-inputs.outputs.version_display }}"
          echo "ğŸ·ï¸ VERSION TYPE: ${{ needs.validate-inputs.outputs.version_type }}"
          echo "=========================================="

          # ç¯å¢ƒæ ‡è¯†æ˜¾ç¤º
          if [[ "${{ needs.validate-inputs.outputs.environment }}" == "production" ]]; then
            echo "ğŸš¨ğŸš¨ğŸš¨ PRODUCTION DEPLOYMENT FAILED ğŸš¨ğŸš¨ğŸš¨"
            echo "âš ï¸  PRODUCTION ENVIRONMENT IS NOT AFFECTED!"
            echo "âš ï¸  URGENT: Please fix and redeploy immediately!"
          else
            echo "ğŸ§ªğŸ§ªğŸ§ª STAGING DEPLOYMENT FAILED ğŸ§ªğŸ§ªğŸ§ª"
            echo "âœ…  STAGING ENVIRONMENT IS NOT AFFECTED!"
            echo "ğŸ”§  Please fix and redeploy to staging first."
          fi
          echo "=========================================="

          echo "Environment: ${{ needs.validate-inputs.outputs.environment }}"
          echo "Version: ${{ needs.validate-inputs.outputs.image_tag }}"
          echo "Repository: ${{ github.repository }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Deploy time: $(date)"
          echo "Please check the deployment logs and fix the issue."
