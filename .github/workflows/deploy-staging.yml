# .github/workflows/deploy-staging.yml
name: Deploy to Staging
on:
  push:
    branches: [main]

jobs:
  deploy-staging:
    # åªåœ¨æ¨é€åˆ° main æˆ– PR åˆå¹¶åˆ° main æ—¶æ‰§è¡Œ
    if: github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Staging
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ vars.STAGING_HOST }}
          username: ${{ vars.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting Staging deployment..."
            echo "Target: ${{ vars.STAGING_HOST }}"
            echo "User: ${{ vars.STAGING_USERNAME }}"
            echo "Repository: ${{ github.repository }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo "Deploy time: $(date)"

            # ç¡®ä¿ç›®å½•å­˜åœ¨
            sudo mkdir -p /opt/avatar-mgmt
            sudo chown $USER:$USER /opt/avatar-mgmt
            sudo chmod 755 /opt/avatar-mgmt

            cd /opt/avatar-mgmt

            # æ£€æŸ¥å¹¶åˆå§‹åŒ– Git ä»“åº“
            IS_FIRST_DEPLOY=false
            if [ ! -d ".git" ]; then
              echo " Git repository not found, cloning..."
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts
              git clone git@github.com:${{ github.repository }}.git .
              if [ $? -ne 0 ]; then
                echo "âŒ Failed to clone repository"
                exit 1
              fi
              echo "âœ… Repository cloned successfully"
              IS_FIRST_DEPLOY=true
              echo "é¦–æ¬¡éƒ¨ç½²ï¼Œå°†åœ¨æœ€åæ‰§è¡Œ directus/setup-directus-permissions.js è„šæœ¬è®¾ç½®æƒé™å’Œå¯¼å…¥æ•°æ®"
            else
              echo "ğŸ“¥ Git repository found, updating..."
              # å¤‡ä»½å½“å‰ç‰ˆæœ¬
              if git rev-parse HEAD >/dev/null 2>&1; then
                echo " Backing up current version..."
                git rev-parse HEAD > .backup-commit.txt
              fi
              
              # æ‹‰å–æœ€æ–°ä»£ç 
              echo "ğŸ“¥ Pulling latest code..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd frontend/ api-server/ scripts/ || true
              echo "âœ… Repository updated successfully"
            fi

            sudo chown -R $USER:$USER /opt/avatar-mgmt

            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            if [ ! -f ".env.stage.api" ]; then
              echo "âŒ Staging config file not found!"
              echo "Please create .env.stage.api on the server"
              echo "You can copy from .env.stage.template if available"
              exit 1
            fi

            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            if [ ! -f ".env.stage.directus" ]; then
              echo "âŒ Staging config file not found!"
              echo "Please create .env.stage.directus on the server"
              echo "You can copy from .env.stage.template if available"
              exit 1
            fi

            # ç¡®ä¿ Volta å·²å®‰è£…å¹¶åŠ è½½
            if ! command -v volta &> /dev/null; then
              echo " Installing Volta..."
              sudo curl https://get.volta.sh | bash
              export VOLTA_HOME="$HOME/.volta"
              export PATH="$VOLTA_HOME/bin:$PATH"
            fi

            # åŠ è½½ Volta ç¯å¢ƒ
            export VOLTA_HOME="$HOME/.volta"
            export PATH="$VOLTA_HOME/bin:$PATH"

            # å®‰è£…é¡¹ç›®æŒ‡å®šçš„ Node.js å’Œ Yarn ç‰ˆæœ¬
            echo " Installing Node.js and Yarn via Volta..."
            volta install node@22.16.0
            volta install yarn@1.22.22

            # éªŒè¯ç‰ˆæœ¬
            echo " Verifying versions..."
            node --version
            yarn --version

            # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo "ğŸ”§ Setting up environment variables..."
            export STAGING_HOST="${{ vars.STAGING_HOST }}"
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export GITHUB_REF_NAME="${{ github.ref_name }}"
            export GITHUB_SHA="${{ github.sha }}"

            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo "ğŸš€ Executing deployment script..."
            chmod +x .github/scripts/deploy-staging.sh
            .github/scripts/deploy-staging.sh

            # å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œæ‰§è¡Œ Directus æƒé™è®¾ç½®è„šæœ¬
            if [ "$IS_FIRST_DEPLOY" = "true" ]; then
              echo "ğŸš€ é¦–æ¬¡éƒ¨ç½²æ£€æµ‹åˆ°ï¼Œæ­£åœ¨æ‰§è¡Œ Directus æƒé™è®¾ç½®è„šæœ¬..."
              
              # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
              echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
              sleep 60
              
              # æ£€æŸ¥ Directus æœåŠ¡æ˜¯å¦å°±ç»ª
              echo "ğŸ” æ£€æŸ¥ Directus æœåŠ¡çŠ¶æ€..."
              if curl -f http://localhost:8055/ > /dev/null 2>&1; then
                echo "âœ… Directus æœåŠ¡å·²å°±ç»ªï¼Œå¼€å§‹æ‰§è¡Œæƒé™è®¾ç½®è„šæœ¬..."
                
                # å®‰è£… Node.js ä¾èµ–
                echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
                cd directus
                npm install node-fetch
                
                # æ‰§è¡Œæƒé™è®¾ç½®è„šæœ¬
                echo "ğŸ”§ æ‰§è¡Œæƒé™è®¾ç½®è„šæœ¬..."
                node setup-directus-permissions.js
                
                if [ $? -eq 0 ]; then
                  echo "âœ… Directus æƒé™è®¾ç½®è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼"
                else
                  echo "âš ï¸  Directus æƒé™è®¾ç½®è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
                fi
                
                cd ..
              else
                echo "âŒ Directus æœåŠ¡æœªå°±ç»ªï¼Œè·³è¿‡æƒé™è®¾ç½®è„šæœ¬"
                echo "âš ï¸  è¯·æ‰‹åŠ¨æ‰§è¡Œ: cd directus && node setup-directus-permissions.js"
              fi
            else
              echo "ğŸ“ éé¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡æƒé™è®¾ç½®è„šæœ¬"
            fi

      - name: Health check
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ vars.STAGING_HOST }}
          username: ${{ vars.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/avatar-mgmt
            echo "ğŸ” Starting health check..."

            # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œå¥åº·æ£€æŸ¥è„šæœ¬
            export DOCKER_COMPOSE_FILE="docker-compose.stage.yml"
            chmod +x .github/scripts/health-check.sh
            .github/scripts/health-check.sh

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Staging deployment successful!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deploy time: $(date)"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Staging deployment failed!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deploy time: $(date)"
