# .github/workflows/build-images.yml
name: Build and Push Docker Images
on:
  release:
    types: [published, prereleased]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/api
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'yarn'

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version information
        run: |
          chmod +x scripts/generate-version.sh
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "ðŸ§ª Pre-release detected, using staging environment"
            ./scripts/generate-version.sh stage
          else
            echo "ðŸš€ Release detected, using production environment"
            ./scripts/generate-version.sh production
          fi

          # éªŒè¯ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          echo "ðŸ“ Checking generated version file..."
          ls -la api-server/version/
          cat api-server/version/version.json

      - name: Build frontend
        run: |
          cd frontend
          yarn install --frozen-lockfile

          # æž„å»ºå‰ç«¯ (ä¸æ³¨å…¥çŽ¯å¢ƒå˜é‡)
          yarn build --mode production

      - name: Prepare API build context
        run: |
          echo "ðŸ”§ å‡†å¤‡ API æž„å»ºä¸Šä¸‹æ–‡..."
          # å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ° api-server ç›®å½•
          cp -r frontend/public api-server/
          echo "âœ… å·²å¤åˆ¶ frontend/public åˆ° api-server/"

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.event.release.tag_name }}
            ${{ github.event.release.prerelease == false && format('{0}/{1}:latest', env.REGISTRY, env.IMAGE_NAME_FRONTEND) || '' }}
            ${{ github.event.release.prerelease == true && format('{0}/{1}:staging', env.REGISTRY, env.IMAGE_NAME_FRONTEND) || '' }}

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: api-server
          file: api-server/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ github.event.release.tag_name }}
            ${{ github.event.release.prerelease == false && format('{0}/{1}:latest', env.REGISTRY, env.IMAGE_NAME_API) || '' }}
            ${{ github.event.release.prerelease == true && format('{0}/{1}:staging', env.REGISTRY, env.IMAGE_NAME_API) || '' }}
          build-args: |
            BUILD_VERSION=${{ github.event.release.tag_name }}
            BUILD_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_started_at }}
            BUILD_REPOSITORY=${{ github.repository }}
            BUILD_BRANCH=${{ github.ref_name }}
            BUILD_RUN_ID=${{ github.run_id }}
            RELEASE_TAG=${{ github.event.release.tag_name }}

      - name: Generate build summary
        run: |
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "## ðŸ§ª Pre-release Images Built and Pushed to GHCR" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pre-release Version**: \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Target Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸš€ Release Images Built and Pushed to GHCR" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release Version**: \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Target Environment**: Production" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:staging" >> $GITHUB_STEP_SUMMARY
          else
            echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:staging" >> $GITHUB_STEP_SUMMARY
          else
            echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Name**: \`${{ github.event.release.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Is Pre-release**: \`${{ github.event.release.prerelease }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: \`${{ github.run_started_at }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull specific version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "# Pull staging alias" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:staging" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:staging" >> $GITHUB_STEP_SUMMARY
          else
            echo "# Pull latest alias" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:latest" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
