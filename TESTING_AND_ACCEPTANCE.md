# Unity WebGL è¿ç§»æµ‹è¯•ç¨‹åºä¸éªŒæ”¶æ ‡å‡†

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯ä» three.js/GLTFLoader åˆ° Unity WebGL +
iframe æ¶æ„çš„å®Œæ•´è¿ç§»ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œï¼Œæ€§èƒ½è¾¾æ ‡ï¼Œå®‰å…¨å¯é ã€‚

---

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### Unity é¡¹ç›®è®¾ç½®

1. **C# è„šæœ¬éƒ¨ç½²**

   ```
   Assets/Scripts/JsTalker.cs
   Assets/Scripts/AvatarController.cs
   ```

2. **æ’ä»¶éƒ¨ç½²**

   ```
   Assets/Plugins/vue_unity.jslib
   ```

3. **åœºæ™¯é…ç½®**
   - åˆ›å»ºåä¸º "JsBridge" çš„GameObject
   - æŒ‚è½½ JsTalker å’Œ AvatarController è„šæœ¬
   - ç¡®ä¿æ•°å­—äººæ¨¡å‹æ­£ç¡®å¯¼å…¥å¹¶é…ç½®

4. **WebGL æ„å»ºè®¾ç½®**
   - Player Settings > WebGL Settings
   - å¯ç”¨ Data Caching
   - å‹ç¼©æ ¼å¼ï¼šBrotli
   - æ¨¡æ¿ï¼šDefault

### Vue é¡¹ç›®è®¾ç½®

1. **ç»„ä»¶æ›¿æ¢**

   ```bash
   # å¤‡ä»½åŸç»„ä»¶
   mv ModelViewer.vue ModelViewer.three.vue.backup

   # éƒ¨ç½²æ–°ç»„ä»¶
   cp UnityModelViewer.vue ModelViewer.vue
   ```

2. **ç¯å¢ƒå˜é‡é…ç½®**

   ```env
   VITE_UNITY_BASE_URL=/unity_sample
   VITE_ENABLE_UNITY_DEBUG=true
   ```

3. **ä¾èµ–å®‰è£…**
   ```bash
   cd frontend
   npm install
   ```

### æœåŠ¡å™¨è®¾ç½®

1. **Nginx é…ç½®éƒ¨ç½²**

   ```bash
   sudo cp server-configs/nginx-unity-webgl.conf /etc/nginx/sites-available/
   sudo ln -s /etc/nginx/sites-available/nginx-unity-webgl.conf /etc/nginx/sites-enabled/
   sudo nginx -t && sudo systemctl reload nginx
   ```

2. **Node.js æœåŠ¡å™¨å¯åŠ¨**
   ```bash
   cd server-configs
   npm install
   npm start
   ```

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### Test 1: Unity WebGL åŠ è½½æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ Unity WebGL æ­£ç¡®åŠ è½½å¹¶å»ºç«‹é€šä¿¡

**æ­¥éª¤**:

1. è®¿é—® `http://localhost:3000`
2. å¯¼èˆªåˆ°æ•°å­—äººå±•ç¤ºé¡µé¢
3. è§‚å¯Ÿ Unity iframe åŠ è½½è¿‡ç¨‹

**é¢„æœŸç»“æœ**:

- âœ… Unity åŠ è½½è¿›åº¦æ¡æ­£å¸¸æ˜¾ç¤º
- âœ… æ§åˆ¶å°è¾“å‡º "Unity ready with avatar: [avatarId]"
- âœ… Vue ç»„ä»¶æ¥æ”¶åˆ° `unity-ready` äº‹ä»¶
- âœ… åŠ è½½å®Œæˆåæ˜¾ç¤ºæ•°å­—äººæ¨¡å‹

**éªŒæ”¶æ ‡å‡†**:

- åŠ è½½æ—¶é—´ < 10ç§’
- æ—  JavaScript é”™è¯¯
- postMessage é€šä¿¡æ­£å¸¸

---

### Test 2: åŠ¨ç”»æ§åˆ¶æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ Vue åˆ° Unity çš„åŠ¨ç”»æ§åˆ¶

**æ­¥éª¤**:

1. Unity åŠ è½½å®Œæˆå
2. åœ¨ Vue ç•Œé¢è§¦å‘åŠ¨ç”»æ’­æ”¾
3. æµ‹è¯•ä¸åŒåŠ¨ç”»ç±»å‹ï¼šidle, wave, dance ç­‰

**é¢„æœŸç»“æœ**:

- âœ… Unity æ•°å­—äººæ‰§è¡Œç›¸åº”åŠ¨ç”»
- âœ… åŠ¨ç”»è¿‡æ¸¡è‡ªç„¶æµç•…
- âœ… å¾ªç¯/éå¾ªç¯åŠ¨ç”»æŒ‰é¢„æœŸå·¥ä½œ

**æµ‹è¯•ä»£ç **:

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const modelViewer =
  document.querySelector('unity-model-viewer').__vueParentComponent.exposed;

// æµ‹è¯•åŠ¨ç”»æ’­æ”¾
modelViewer.playAnimation('wave', 3, false);
setTimeout(() => {
  modelViewer.playAnimation('dance', 0, true);
}, 4000);
```

**éªŒæ”¶æ ‡å‡†**:

- åŠ¨ç”»å“åº”æ—¶é—´ < 100ms
- åŠ¨ç”»åˆ‡æ¢æ— å¡é¡¿
- æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å·¥ä½œæ­£å¸¸

---

### Test 3: è¡¨æƒ…æ§åˆ¶æµ‹è¯•

**ç›®æ ‡**: éªŒè¯æ•°å­—äººè¡¨æƒ…æ§åˆ¶åŠŸèƒ½

**æ­¥éª¤**:

1. æµ‹è¯•å•ä¸€è¡¨æƒ…åˆ‡æ¢
2. æµ‹è¯•è¡¨æƒ…æ··åˆåŠŸèƒ½
3. æµ‹è¯•è¡¨æƒ…è¿‡æ¸¡æ•ˆæœ

**é¢„æœŸç»“æœ**:

- âœ… å•ä¸€è¡¨æƒ…æ­£ç¡®æ˜¾ç¤º
- âœ… è¡¨æƒ…æ··åˆæ•ˆæœè‡ªç„¶
- âœ… è¿‡æ¸¡åŠ¨ç”»æµç•…

**æµ‹è¯•ä»£ç **:

```javascript
// å•ä¸€è¡¨æƒ…æµ‹è¯•
modelViewer.updateEmotion('happy', 0.5);
setTimeout(() => modelViewer.updateEmotion('sad', 1.0), 2000);

// æ··åˆè¡¨æƒ…æµ‹è¯•
modelViewer.blendEmotions([
  { emotion: 'happy', weight: 0.7 },
  { emotion: 'surprised', weight: 0.3 },
]);
```

**éªŒæ”¶æ ‡å‡†**:

- è¡¨æƒ…å˜åŒ–è‡ªç„¶
- è¿‡æ¸¡æ—¶é—´å‡†ç¡®
- æ”¯æŒå®æ—¶æ··åˆ

---

### Test 4: éŸ³ç´ åŒæ­¥æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ TTS éŸ³ç´ åŒæ­¥åŠŸèƒ½

**æ­¥éª¤**:

1. æ’­æ”¾å¸¦éŸ³ç´ æ•°æ®çš„éŸ³é¢‘
2. è§‚å¯Ÿå£å‹å˜åŒ–
3. æµ‹è¯•ä¸åŒè¯­è¨€çš„éŸ³ç´ 

**é¢„æœŸç»“æœ**:

- âœ… å£å‹ä¸éŸ³é¢‘åŒæ­¥
- âœ… éŸ³ç´ åˆ‡æ¢è‡ªç„¶
- âœ… æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡éŸ³ç´ 

**æµ‹è¯•ä»£ç **:

```javascript
// æ¨¡æ‹ŸéŸ³ç´ åºåˆ—
const visemeSequence = [0, 1, 3, 7, 12, 8, 0];
visemeSequence.forEach((visemeId, index) => {
  setTimeout(() => {
    modelViewer.updateViseme(visemeId);
  }, index * 200);
});
```

---

### Test 5: å¤šæ•°å­—äººåˆ‡æ¢æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ä¸åŒæ•°å­—äººä¹‹é—´çš„åˆ‡æ¢

**æ­¥éª¤**:

1. åŠ è½½æ•°å­—äºº A
2. åˆ‡æ¢åˆ°æ•°å­—äºº B
3. éªŒè¯å†…å­˜é‡Šæ”¾å’Œæ–°å®ä¾‹åˆ›å»º

**é¢„æœŸç»“æœ**:

- âœ… æ—§å®ä¾‹æ­£ç¡®é‡Šæ”¾
- âœ… æ–°å®ä¾‹æ­£å¸¸åŠ è½½
- âœ… åŠŸèƒ½æ— æŸå¤±

**æµ‹è¯•ä»£ç **:

```javascript
// åˆ‡æ¢æ•°å­—äºº
modelViewer.avatarId = 'avatar-b';
```

**éªŒæ”¶æ ‡å‡†**:

- åˆ‡æ¢æ—¶é—´ < 15ç§’
- æ— å†…å­˜æ³„æ¼
- åŠŸèƒ½å®Œå…¨æ­£å¸¸

---

## ğŸš€ æ€§èƒ½æµ‹è¯•

### Test 6: åŠ è½½æ€§èƒ½æµ‹è¯•

**æŒ‡æ ‡**:

- Unity WebGL åˆå§‹åŠ è½½æ—¶é—´
- é¦–æ¬¡äº¤äº’å“åº”æ—¶é—´
- èµ„æºæ–‡ä»¶å¤§å°

**å·¥å…·**:

- Chrome DevTools Performance é¢æ¿
- Lighthouse æ€§èƒ½æ£€æµ‹
- Network é¢æ¿ç›‘æ§

**éªŒæ”¶æ ‡å‡†**:

- åˆå§‹åŠ è½½ < 10ç§’ (3Gç½‘ç»œ)
- é¦–æ¬¡äº¤äº’ < 2ç§’
- æ€»èµ„æºå¤§å° < 50MB

### Test 7: è¿è¡Œæ—¶æ€§èƒ½æµ‹è¯•

**æŒ‡æ ‡**:

- å¸§ç‡ç¨³å®šæ€§ (60fps)
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- CPU å ç”¨ç‡

**æµ‹è¯•æ–¹æ³•**:

```javascript
// æ€§èƒ½ç›‘æ§è„šæœ¬
const monitor = {
  startTime: performance.now(),
  frameCount: 0,

  measureFPS() {
    requestAnimationFrame(() => {
      this.frameCount++;
      const elapsed = performance.now() - this.startTime;
      if (elapsed >= 1000) {
        const fps = Math.round((this.frameCount * 1000) / elapsed);
        console.log(`FPS: ${fps}`);
        this.frameCount = 0;
        this.startTime = performance.now();
      }
      this.measureFPS();
    });
  },
};
monitor.measureFPS();
```

**éªŒæ”¶æ ‡å‡†**:

- å¹³å‡å¸§ç‡ â‰¥ 30fps
- å†…å­˜ä½¿ç”¨ < 200MB
- CPU ä½¿ç”¨ç‡ < 50%

---

## ğŸ”’ å®‰å…¨æµ‹è¯•

### Test 8: è·¨åŸŸå®‰å…¨æµ‹è¯•

**ç›®æ ‡**: éªŒè¯ postMessage å®‰å…¨æœºåˆ¶

**æµ‹è¯•æ­¥éª¤**:

1. å°è¯•ä»éæˆæƒåŸŸåå‘é€æ¶ˆæ¯
2. éªŒè¯ CSP å¤´éƒ¨è®¾ç½®
3. æ£€æŸ¥ iframe æ²™ç›’é™åˆ¶

**é¢„æœŸç»“æœ**:

- âœ… éæˆæƒæ¶ˆæ¯è¢«æ‹’ç»
- âœ… CSP æ”¿ç­–ç”Ÿæ•ˆ
- âœ… iframe å®‰å…¨é™åˆ¶æ­£å¸¸

### Test 9: æ–‡ä»¶æœåŠ¡å®‰å…¨æµ‹è¯•

**æ£€æŸ¥é¡¹ç›®**:

- Unity WebGL æ–‡ä»¶çš„ MIME ç±»å‹
- å‹ç¼©æ–‡ä»¶æ­£ç¡®ä¼ è¾“
- ç¼“å­˜ç­–ç•¥å®‰å…¨æ€§

**éªŒè¯å‘½ä»¤**:

```bash
# æ£€æŸ¥ MIME ç±»å‹
curl -I http://localhost:3000/unity_sample/Build/unity_sample.wasm.unityweb

# æ£€æŸ¥å‹ç¼©
curl -H "Accept-Encoding: br" -I http://localhost:3000/unity_sample/Build/unity_sample.data.unityweb

# æ£€æŸ¥ç¼“å­˜å¤´
curl -I http://localhost:3000/unity_sample/index.html
```

---

## ğŸŒ å…¼å®¹æ€§æµ‹è¯•

### Test 10: æµè§ˆå™¨å…¼å®¹æ€§

**æµ‹è¯•æµè§ˆå™¨**:

- Chrome (æœ€æ–°ç‰ˆæœ¬)
- Firefox (æœ€æ–°ç‰ˆæœ¬)
- Safari (æœ€æ–°ç‰ˆæœ¬)
- Edge (æœ€æ–°ç‰ˆæœ¬)

**æµ‹è¯•é¡¹ç›®**:

- Unity WebGL åŠ è½½
- postMessage é€šä¿¡
- WebAssembly æ”¯æŒ
- æ€§èƒ½è¡¨ç°

### Test 11: è®¾å¤‡å…¼å®¹æ€§

**æµ‹è¯•è®¾å¤‡**:

- Windows æ¡Œé¢ (1920x1080)
- macOS æ¡Œé¢ (2560x1600)
- iPad (1024x768)
- ç§»åŠ¨è®¾å¤‡ (375x667)

**æ³¨æ„**: Unity WebGL åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ”¯æŒæœ‰é™

---

## ğŸ“Š å›å½’æµ‹è¯•

### Test 12: åŸæœ‰åŠŸèƒ½éªŒè¯

**ç›®æ ‡**: ç¡®ä¿è¿ç§»ä¸å½±å“ç°æœ‰åŠŸèƒ½

**æµ‹è¯•æ¸…å•**:

- [ ] ç”¨æˆ·ç™»å½•/ç™»å‡º
- [ ] æ•°å­—äººåˆ—è¡¨å±•ç¤º
- [ ] éŸ³é¢‘æ’­æ”¾æ§åˆ¶
- [ ] èƒŒæ™¯å›¾ç‰‡è®¾ç½®
- [ ] æ•°æ®ä¿å­˜/åŠ è½½
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] å“åº”å¼å¸ƒå±€

---

## âœ… éªŒæ”¶æ ‡å‡†æ€»è§ˆ

### å¿…é¡»é€šè¿‡ (Must Pass)

- [ ] Unity WebGL æ­£ç¡®åŠ è½½å¹¶å»ºç«‹é€šä¿¡
- [ ] æ‰€æœ‰åŠ¨ç”»æ§åˆ¶åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è¡¨æƒ…ç³»ç»Ÿå®Œå…¨å¯ç”¨
- [ ] éŸ³ç´ åŒæ­¥åŠŸèƒ½æ­£å¸¸
- [ ] æ•°å­—äººåˆ‡æ¢æ— é—®é¢˜
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾åˆ°è¦æ±‚
- [ ] å®‰å…¨æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] ä¸»æµæµè§ˆå™¨å…¼å®¹

### å»ºè®®é€šè¿‡ (Should Pass)

- [ ] åŠ è½½æ—¶é—´ä¼˜åŒ–åˆ°ä½
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- [ ] è°ƒè¯•ä¿¡æ¯å®Œæ•´
- [ ] ä»£ç æ–‡æ¡£å®Œæ•´
- [ ] ç§»åŠ¨ç«¯åŸºæœ¬å¯ç”¨

### å¯é€‰é€šè¿‡ (Could Pass)

- [ ] é«˜çº§æ€§èƒ½ä¼˜åŒ–
- [ ] é¢å¤–çš„è°ƒè¯•å·¥å…·
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–

---

## ğŸ› é—®é¢˜æ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

**é—®é¢˜ 1: Unity åŠ è½½å¤±è´¥**

```javascript
// æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
console.error('Unity loading failed');

// è§£å†³æ–¹æ¡ˆ
// 1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„
// 2. éªŒè¯ MIME ç±»å‹è®¾ç½®
// 3. æ£€æŸ¥æœåŠ¡å™¨å‹ç¼©é…ç½®
```

**é—®é¢˜ 2: postMessage é€šä¿¡å¤±è´¥**

```javascript
// è°ƒè¯•ä»£ç 
window.addEventListener('message', event => {
  console.log('Received message:', event);
});

// è§£å†³æ–¹æ¡ˆ
// 1. æ£€æŸ¥æ¶ˆæ¯æ ¼å¼
// 2. éªŒè¯å‘é€æ–¹å’Œæ¥æ”¶æ–¹
// 3. ç¡®è®¤å®‰å…¨ç­–ç•¥
```

**é—®é¢˜ 3: åŠ¨ç”»ä¸å“åº”**

```javascript
// æ£€æŸ¥ Unity å°±ç»ªçŠ¶æ€
console.log('Unity ready:', isUnityReady);

// è§£å†³æ–¹æ¡ˆ
// 1. ç¡®è®¤ Unity å®Œå…¨åŠ è½½
// 2. æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶
// 3. éªŒè¯ C# è„šæœ¬é…ç½®
```

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
## Unity WebGL è¿ç§»æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: [YYYY-MM-DD] **æµ‹è¯•ç¯å¢ƒ**: [æµè§ˆå™¨/è®¾å¤‡/ç½‘ç»œ] **æµ‹è¯•äººå‘˜**: [å§“å]

### æµ‹è¯•ç»“æœæ‘˜è¦

- é€šè¿‡æµ‹è¯•: X/12
- å¤±è´¥æµ‹è¯•: X/12
- æ€»ä½“è¯„ä¼°: [é€šè¿‡/éƒ¨åˆ†é€šè¿‡/å¤±è´¥]

### è¯¦ç»†ç»“æœ

| æµ‹è¯•é¡¹     | çŠ¶æ€  | å¤‡æ³¨       |
| ---------- | ----- | ---------- |
| Unity åŠ è½½ | âœ…/âŒ | [è¯¦ç»†è¯´æ˜] |
| åŠ¨ç”»æ§åˆ¶   | âœ…/âŒ | [è¯¦ç»†è¯´æ˜] |
| ...        | ...   | ...        |

### å‘ç°çš„é—®é¢˜

1. [é—®é¢˜æè¿°]
   - ä¸¥é‡ç¨‹åº¦: [é«˜/ä¸­/ä½]
   - é‡ç°æ­¥éª¤: [è¯¦ç»†æ­¥éª¤]
   - å»ºè®®è§£å†³æ–¹æ¡ˆ: [è§£å†³æ–¹æ¡ˆ]

### æ€§èƒ½æ•°æ®

- åŠ è½½æ—¶é—´: Xs
- å¹³å‡ FPS: X
- å†…å­˜ä½¿ç”¨: XMB

### å»ºè®®

[æµ‹è¯•å»ºè®®å’Œæ”¹è¿›æ„è§]
```

---

## ğŸ‰ éƒ¨ç½²å‰æœ€ç»ˆæ£€æŸ¥

åœ¨æ­£å¼éƒ¨ç½²å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. **âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡**
2. **âœ… æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡**
3. **âœ… å®‰å…¨é…ç½®æ­£ç¡®**
4. **âœ… å¤‡ä»½è®¡åˆ’å‡†å¤‡**
5. **âœ… å›æ»šæ–¹æ¡ˆæµ‹è¯•**
6. **âœ… ç›‘æ§ç³»ç»Ÿå°±ç»ª**
7. **âœ… å›¢é˜ŸåŸ¹è®­å®Œæˆ**

---

_æ­¤æµ‹è¯•ç¨‹åºåº”åœ¨æ¯æ¬¡è¿ç§»å®æ–½å‰æ‰§è¡Œï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šå¯é ã€‚_
