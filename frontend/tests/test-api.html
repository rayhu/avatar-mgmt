<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API è¿æ¥æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” API è¿æ¥æµ‹è¯•</h1>

    <div class="test-section">
      <h3>ğŸ¥ å¥åº·æ£€æŸ¥</h3>
      <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
      <div id="health-result"></div>
    </div>

    <div class="test-section">
      <h3>ğŸ“ SSML ç”Ÿæˆæµ‹è¯•</h3>
      <input
        type="text"
        id="test-text"
        value="ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚"
        style="width: 300px; padding: 5px"
      />
      <button onclick="testSSML()">ç”Ÿæˆ SSML</button>
      <div id="ssml-result"></div>
    </div>

    <div class="test-section">
      <h3>ğŸ”Š è¯­éŸ³åˆæˆæµ‹è¯•</h3>
      <button onclick="testTTS()">æµ‹è¯•è¯­éŸ³åˆæˆ</button>
      <div id="tts-result"></div>
      <audio id="audio-player" controls style="margin-top: 10px"></audio>
    </div>

    <div class="test-section">
      <h3>ğŸ¯ ä¸€é”®æ–‡æœ¬è½¬è¯­éŸ³</h3>
      <input
        type="text"
        id="text-to-speech"
        value="æ¬¢è¿ä½¿ç”¨è¯­éŸ³åˆæˆç³»ç»Ÿï¼"
        style="width: 300px; padding: 5px"
      />
      <button onclick="testTextToSpeech()">æ–‡æœ¬è½¬è¯­éŸ³</button>
      <div id="text-to-speech-result"></div>
      <audio id="text-to-speech-audio" controls style="margin-top: 10px"></audio>
    </div>

    <script>
      const API_BASE_URL = 'http://localhost:3000';

      function log(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        const className = isError ? 'error' : 'success';
        element.innerHTML = `<div class="${className}"><pre>${message}</pre></div>`;
      }

      async function testHealth() {
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          const text = await response.text();
          log('health-result', `çŠ¶æ€: ${response.status}\nå“åº”: ${text}`);
        } catch (error) {
          log('health-result', `é”™è¯¯: ${error.message}`, true);
        }
      }

      async function testSSML() {
        try {
          const text = document.getElementById('test-text').value;
          const response = await fetch(`${API_BASE_URL}/api/generate-ssml`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, voice: 'zh-CN-XiaoxiaoNeural' }),
          });

          if (response.ok) {
            const data = await response.json();
            log('ssml-result', `æˆåŠŸ!\nSSML é•¿åº¦: ${data.ssml.length}\nSSML å†…å®¹:\n${data.ssml}`);
          } else {
            const error = await response.text();
            log('ssml-result', `é”™è¯¯: ${response.status} - ${error}`, true);
          }
        } catch (error) {
          log('ssml-result', `ç½‘ç»œé”™è¯¯: ${error.message}`, true);
        }
      }

      async function testTTS() {
        try {
          const ssml =
            '<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="zh-CN"><voice name="zh-CN-XiaoxiaoNeural">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚</voice></speak>';
          const response = await fetch(`${API_BASE_URL}/api/azure-tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ssml, voice: 'zh-CN-XiaoxiaoNeural' }),
          });

          if (response.ok) {
            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            document.getElementById('audio-player').src = audioUrl;
            log(
              'tts-result',
              `æˆåŠŸ!\néŸ³é¢‘å¤§å°: ${(blob.size / 1024).toFixed(2)} KB\néŸ³é¢‘ç±»å‹: ${blob.type}`
            );
          } else {
            const error = await response.text();
            log('tts-result', `é”™è¯¯: ${response.status} - ${error}`, true);
          }
        } catch (error) {
          log('tts-result', `ç½‘ç»œé”™è¯¯: ${error.message}`, true);
        }
      }

      async function testTextToSpeech() {
        try {
          const text = document.getElementById('text-to-speech').value;

          // 1. ç”Ÿæˆ SSML
          const ssmlResponse = await fetch(`${API_BASE_URL}/api/generate-ssml`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, voice: 'zh-CN-XiaoxiaoNeural' }),
          });

          if (!ssmlResponse.ok) {
            const error = await ssmlResponse.text();
            log('text-to-speech-result', `SSML ç”Ÿæˆå¤±è´¥: ${ssmlResponse.status} - ${error}`, true);
            return;
          }

          const ssmlData = await ssmlResponse.json();

          // 2. åˆæˆè¯­éŸ³
          const ttsResponse = await fetch(`${API_BASE_URL}/api/azure-tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ssml: ssmlData.ssml, voice: 'zh-CN-XiaoxiaoNeural' }),
          });

          if (ttsResponse.ok) {
            const blob = await ttsResponse.blob();
            const audioUrl = URL.createObjectURL(blob);
            document.getElementById('text-to-speech-audio').src = audioUrl;
            log(
              'text-to-speech-result',
              `æˆåŠŸ!\nSSML é•¿åº¦: ${ssmlData.ssml.length}\néŸ³é¢‘å¤§å°: ${(blob.size / 1024).toFixed(2)} KB`
            );
          } else {
            const error = await ttsResponse.text();
            log('text-to-speech-result', `è¯­éŸ³åˆæˆå¤±è´¥: ${ttsResponse.status} - ${error}`, true);
          }
        } catch (error) {
          log('text-to-speech-result', `ç½‘ç»œé”™è¯¯: ${error.message}`, true);
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
      window.onload = testHealth;
    </script>
  </body>
</html>
